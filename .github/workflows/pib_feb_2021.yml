name: PIB_India_Feb_2021

on:
  push:
    tags:
      - 'v2021_Feb'

  workflow_dispatch:

jobs:

  pib_articles:
    runs-on: ubuntu-latest

    env:
      PIB_MONTH: Feb
      PIB_YEAR: 2021

    steps:
      - uses: actions/checkout@v2

      - name: setting_up
        env:
          ACTIONS_ALLOW_UNSECURE_COMMANDS: 'true'
        run:  |
          sudo apt update
          sudo apt install --fix-missing -y python3 wkhtmltopdf fd-find poppler-utils
          sudo ln -s $(which fdfind) /usr/bin/fd
          sudo pip install -r requirements.txt

      - name: run script
        run:  |
          source .env
          pib_month ${{ env.PIB_MONTH }} ${{ env.PIB_YEAR }}

      - name: make txt files
        run:  |
          source .env
          pdftxt

      - name: zipup_months_articles
        run:  |
          cd /home/runner/pib/${{ env.PIB_YEAR }}
          zip -r "PIB_${{ env.PIB_MONTH }}_${{ env.PIB_YEAR }}.zip" ${{ env.PIB_MONTH }}

      - name: zipup_months_articles_by_days
        run:  |
          cd /home/runner/pib/${{ env.PIB_YEAR }}/${{ env.PIB_MONTH }}
          for day in *; do
            zip -r "PIB_$day_${{ env.PIB_MONTH }}_${{ env.PIB_YEAR }}.zip" $day
          done

      - name: zipup_text
        run:  |
          cd /home/runner/pib_text/${{ env.PIB_YEAR }}
          zip -r "PIB_TEXT_${{ env.PIB_MONTH }}_${{ env.PIB_YEAR }}.zip" ${{ env.PIB_MONTH }}

      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: "/home/runner/pib/${{ env.PIB_YEAR }}/*.zip, /home/runner/pib/${{ env.PIB_YEAR }}/${{ env.PIB_MONTH }}/*.zip, /home/runner/pib_text/${{ env.PIB_YEAR }}/*.zip"
          token: ${{ secrets.PIB }}
